@model FarmacyMedic.Models.DTO.ProductDetailCreationDto

<h2>Detalles del Pedido</h2>

<form method="post" action="@Url.Action("AgregarProducto", "Order",new { orderId = ViewData["OrderId"] })">
    <div class="form-group">
        <label for="ProductName">Buscar Producto:</label>
        <input type="text" id="productName" class="form-control" onkeyup="buscarProducto()" />
    </div>

    <div class="row">
        <div class="col-md-6">
            <h3>Productos Disponibles</h3>
            <ul id="availableProducts" class="list-group">
            </ul>
        </div>
        <div class="col-md-6">
            <h3>Productos Seleccionados</h3>
            <ul id="selectedProducts" class="list-group">
            </ul>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <h3>Detalles de los Productos Seleccionados</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                    </tr>
                </thead>
                <tbody id="productDetails">
                </tbody>
            </table>
        </div>
    </div>

    <button type="submit" id="listoButton" class="btn btn-primary mt-3">Listo</button>
</form>


<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRPifzW3RAwTbkkW8nx9vOtl1TkpTd7Fzj2HXM1Bt" crossorigin="anonymous"></script>

@section scripts {
    <script>

        function buscarProducto() {
            var productName = document.getElementById('productName').value;

            $.ajax({
                url: '@Url.Action("BuscarProducto", "Order")',
                type: 'GET',
                data: { productName: productName },
                dataType: 'json',
                success: function (data) {
                    var availableProductsList = document.getElementById('availableProducts');
                    availableProductsList.innerHTML = '';

                    data.forEach(function (product) {
                        console.log(data);
                        console.log(product)
                        var listItem = document.createElement('li');
                        listItem.textContent = product.name;
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';

                        var quantityInput = document.createElement('input');
                        quantityInput.type = 'number';
                        quantityInput.min = 1;
                        quantityInput.value = 1;
                        quantityInput.className = 'form-control';

                        var addButton = document.createElement('button');
                        addButton.textContent = 'Agregar';
                        addButton.className = 'btn btn-sm btn-success';
                        addButton.onclick = function () {
                            agregarProductoSeleccionado(product.id, product.name, quantityInput.value);
                        };

                        listItem.appendChild(quantityInput);
                        listItem.appendChild(addButton);
                        availableProductsList.appendChild(listItem);
                    });
                },
                error: function (error) {
                    console.error('Error al buscar el producto:', error);
                }
            });
        }

        var productosSeleccionados = [];

        function agregarProductoSeleccionado(productId, productName, quantity) {
            var selectedProductsList = document.getElementById('selectedProducts');

            var listItem = document.createElement('li');
            listItem.textContent = productName;
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';

            var removeButton = document.createElement('button');
            removeButton.textContent = 'Quitar';
            removeButton.className = 'btn btn-sm btn-danger';
            removeButton.onclick = function () {
                listItem.remove();
                removeProduct(productId);
            };

            listItem.appendChild(removeButton);
            selectedProductsList.appendChild(listItem);

            productosSeleccionados.push({ ProductId: productId, ProductName: productName, Quantity: parseInt(quantity) });
            actualizarDetalles();
        }

        function removeProduct(productId) {
            var index = productosSeleccionados.findIndex(p => p.ProductId === productId);
            if (index !== -1) {
                productosSeleccionados.splice(index, 1);
                actualizarDetalles();
            }
        }

        function actualizarDetalles() {
            var productDetailsList = document.getElementById('productDetails');
            productDetailsList.innerHTML = '';

            productosSeleccionados.forEach(function (product) {
                var row = document.createElement('tr');

                var productNameCell = document.createElement('td');
                productNameCell.textContent = product.ProductName;

                var quantityCell = document.createElement('td');
                quantityCell.textContent = product.Quantity;

                row.appendChild(productNameCell);
                row.appendChild(quantityCell);
                productDetailsList.appendChild(row);
            });

            // Actualizar el valor del campo oculto 'ProductDetail' con los productos seleccionados
            document.getElementById('productDetail').value = JSON.stringify(productosSeleccionados);
        }
        //function listoButtonClicked() {
        //    // Realizar la petición AJAX para agregar los productos al controlador
        //    var productDetailJson = JSON.stringify(productosSeleccionados);
        //    $.ajax({
        //        url: '@Url.Action("ProductByOrder", "Order")',
        //        type: 'POST',
        //        data: {
        //            idOrder: @ViewData["OrderId"],
        //            productDetailCreationDto: productDetailJson
        //        },
        //        dataType: 'json',
        //        success: function (data) {
        //            // Redireccionar a la página de índice (Index)
        //            window.location.href = '@Url.Action("Index", "Orders")';
        //        },
        //        error: function (error) {
        //            console.error('Error al agregar los productos:', error);
        //        }
        //    });
        //}
    </script>
}